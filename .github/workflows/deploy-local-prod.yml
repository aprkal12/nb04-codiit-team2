name: Deploy to AWS (single server)

on:
  push: 
    branches:
      - experiment/redis

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  IMAGE_TAG: ${{ github.sha }}
  AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}

jobs:
  deploy:
    runs-on: ubuntu-latest
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # ============================================
      # Step 1: EC2 ID ì¡°íšŒ
      # ============================================
      - name: Get EC2 Instance ID
        id: get-id
        run: |
          echo "ğŸ” Searching for EC2 Instance ID with tag Name=codiit-dev..."

          # 1. íƒœê·¸(Name=codiit-dev)ì™€ ìƒíƒœ(running)ë¡œ instance ID ì¡°íšŒ
          ID=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=codiit-dev" --query 'Reservations[0].Instances[0].InstanceId' --output text)
          echo "id=$ID" >> $GITHUB_OUTPUT

          # 2. IDë¥¼ ëª» ì°¾ì•˜ì„ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
          if [[ "$ID" == "None" || -z "$ID" ]]; then
            echo "âŒ Error: ì‹¤í–‰ ì¤‘ì¸ 'codiit-dev' ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
        
          echo "âœ… ì°¾ì€ Instance ID: $ID"
      
      # ============================================
      # Step 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      # ============================================
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                    $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "ğŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "âœ… Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      # ============================================
      # Step 3: EC2ì— ë°°í¬ (AWS SSM)
      # ============================================
      # docker-compose, ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼, nginx ì„¤ì • íŒŒì¼ s3ì— ì—…ë¡œë“œ
      - name: Upload docker-compose.yml to S3
        run: |
          aws s3 cp docker-compose.yml s3://$AWS_S3_BUCKET/prod/docker-compose.yml
          aws s3 cp deploy.sh s3://$AWS_S3_BUCKET/prod/deploy.sh
          aws s3 cp nginx/default.conf s3://${{ env.AWS_S3_BUCKET }}/prod/nginx/default.conf
      
      
      - name: Deploy via AWS SSM
        run: |
          # SSM ëª…ë ¹ ë°œì†¡, Command ID ì €ì¥ í›„ ê²€ì¦
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.get-id.outputs.id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "aws s3 cp s3://${{ env.AWS_S3_BUCKET }}/prod/deploy.sh /home/ec2-user/deploy.sh",
              "chmod +x /home/ec2-user/deploy.sh",
              "chown -R ec2-user:ec2-user /home/ec2-user",
              "su - ec2-user -c \"/bin/bash /home/ec2-user/deploy.sh ${{ env.ECR_REGISTRY }} ${{ env.ECR_REPOSITORY }} ${{ github.sha }} ${{ env.AWS_REGION }} ${{ env.AWS_S3_BUCKET }}\""
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "ğŸš€ Command sent! ID: $COMMAND_ID"
          echo "â³ Waiting for command execution..."

          # ëª…ë ¹ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸° 
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.get-id.outputs.id }}"

          # ìµœì¢… ê²°ê³¼ í™•ì¸
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.get-id.outputs.id }}" \
            --query "Status" \
            --output text)

          echo "ğŸ“ Deployment Status: $STATUS"

          if [ "$STATUS" != "Success" ]; then
            echo "âŒ Deployment Failed!"
            # ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¡œê·¸ë¥¼ ì¶œë ¥í•´ì„œ ê¹ƒí—ˆë¸Œì—ì„œ ë°”ë¡œ ë³¼ ìˆ˜ ìˆê²Œ í•¨
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ steps.get-id.outputs.id }}" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          else
            echo "âœ… Deployment Succeeded!"
          fi

      # ============================================
      # Discord ì•Œë¦¼
      # ============================================
      - name: Send Discord notification on success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ!"
          description: |
              - ğŸŒ¿ **ë¸Œëœì¹˜**: ${{ github.ref_name }}
              - ğŸš€ **ë°°í¬ í™˜ê²½**: Production (Single Instance)
              - ğŸ–¥ï¸ **Instance ID**: ${{ steps.get-id.outputs.id }}
              - ğŸ³ **ì´ë¯¸ì§€ íƒœê·¸**: ${{ github.sha }}
              - ğŸ‘¤ **ë°°í¬ì**: ${{ github.actor }}
          color: 0x00FF00
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

      - name: Send Discord notification on failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âŒ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨!"
          description: |
            - ğŸŒ¿ **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            - ğŸš¨ **ì‹¤íŒ¨ ë‹¨ê³„**: Workflow ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
            - ğŸ–¥ï¸ **Instance ID**: ${{ steps.get-id.outputs.id }}
            - ğŸ‘¤ **ë°°í¬ì**: ${{ github.actor }}
          color: 0xFF0000
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

