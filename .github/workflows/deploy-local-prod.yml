name: Deploy to AWS (single server)

on:
  push: 
    branches:
      - experiment/redis

jobs:
  deploy:
    runs-on: ubuntu-latest
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # ============================================
      # Step 1: EC2 ID ì¡°íšŒ
      # ============================================
      - name: Get EC2 Instance ID
        id: get-id
        run: |
          echo "ğŸ” Searching for EC2 Instance ID with tag Name=codiit-dev..."

          # 1. íƒœê·¸(Name=codiit-dev)ì™€ ìƒíƒœ(running)ë¡œ instance ID ì¡°íšŒ
          ID=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=codiit-dev" --query 'Reservations[0].Instances[0].InstanceId' --output text)
          echo "id=$ID" >> $GITHUB_OUTPUT

          # 2. IDë¥¼ ëª» ì°¾ì•˜ì„ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
          if [[ "$ID" == "None" || -z "$ID" ]]; then
            echo "âŒ Error: ì‹¤í–‰ ì¤‘ì¸ 'codiit-dev' ì„œë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
        
          echo "âœ… ì°¾ì€ Public IP: $ID"
      
      # ============================================
      # Step 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      # ============================================
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                    $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "ğŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "âœ… Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      # ============================================
      # Step 3: EC2ì— ë°°í¬ (SSH)
      # ============================================
      - name: Deploy via AWS SSM
        run: |
          aws ssm send-command \
            --instance-ids "${{ steps.get-id.outputs.id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ec2-user",
              
              # 1. ECR ë¡œê·¸ì¸
              "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}",
              
              # 2. ì´ë¯¸ì§€ Pull ë° ì»¨í…Œì´ë„ˆ ê¸°ë™
              # ì•± ë‚´ë¶€ loadEnvFromSSM()ì´ í™˜ê²½ë³€ìˆ˜ë¥¼ ssm parameter storeì—ì„œ ê°€ì ¸ì˜´
              "docker compose pull",
              "docker compose up -d --remove-orphans",

              # 3. Prisma ë§ˆì´ê·¸ë ˆì´ì…˜
              # Prisma CLIëŠ” ì•± ì½”ë“œë¥¼ íƒ€ì§€ ì•Šìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œë§Œ DATABASE_URLì„ parameter storeì—ì„œ ì§ì ‘ ë½‘ì•„ ì£¼ì…í•œë‹¤.
              "export DATABASE_URL=$(aws ssm get-parameter --name \"/codiit/prod/DATABASE_URL\" --with-decryption --query \"Parameter.Value\" --output text)",
              "docker compose run --rm -e DATABASE_URL=$DATABASE_URL api-server ./node_modules/.bin/prisma migrate deploy",
              "unset DATABASE_URL"
            ]'

      - name: Post-deployment Health Check
        run: |
          # SSH ì ‘ì† curl ëŒ€ì‹  AWS SSMì„ í†µí•´ ì›ê²© ì„œë²„ ë‚´ë¶€ì—ì„œ localhostë¡œ curlì„ ì˜ê²Œ í•œë‹¤.
          aws ssm send-command \
            --instance-ids "${{ steps.get-id.outputs.id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["curl -f http://localhost:3000/api/health"]'

      # ============================================
      # ì •ë¦¬: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì‚­ì œ
      # ============================================
      - name: Cleanup old Docker images
        if: success()
        run: |
          aws ssm send-command \
            --instance-ids "${{ steps.get-id.outputs.id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Cleanup unused docker images" \
            --parameters 'commands=[
              "echo ğŸ§¹ Cleaning up unused Docker images...",
              "docker image prune -af --filter \"until=24h\"",
              "echo âœ… Cleanup completed"
            ]'

      # ============================================
      # Discord ì•Œë¦¼
      # ============================================
      - name: Send Discord notification on success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ!"
          description: |
              - ğŸŒ¿ **ë¸Œëœì¹˜**: ${{ github.ref_name }}
              - ğŸš€ **ë°°í¬ í™˜ê²½**: Production (Single Instance)
              - ğŸ–¥ï¸ **ì„œë²„ IP**: ${{ steps.get-ip.outputs.public_ip }}
              - ğŸ³ **ì´ë¯¸ì§€ íƒœê·¸**: ${{ github.sha }}
              - ğŸ‘¤ **ë°°í¬ì**: ${{ github.actor }}
          color: 0x00FF00
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

      - name: Send Discord notification on failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âŒ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨!"
          description: |
            - ğŸŒ¿ **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            - ğŸš¨ **ì‹¤íŒ¨ ë‹¨ê³„**: Workflow ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
            - ğŸ–¥ï¸ **ëŒ€ìƒ ì„œë²„**: ${{ steps.get-ip.outputs.public_ip }}
            - ğŸ‘¤ **ë°°í¬ì**: ${{ github.actor }}
          color: 0xFF0000
          username: GitHub Actions
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

